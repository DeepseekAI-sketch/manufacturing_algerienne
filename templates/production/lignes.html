{% extends "layout.html" %}

{% block title %}Lignes de Production{% endblock %}

{% block custom_css %}
<style>
    .ligne-card {
        transition: all 0.3s ease-in-out;
        border-left-width: 5px;
    }
    .ligne-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
    .ligne-card-disponible { border-left-color: #198754; } /* Green for disponible */
    .ligne-card-occupee { border-left-color: #0dcaf0; } /* Info for occupee */
    .ligne-card-maintenance { border-left-color: #ffc107; } /* Yellow for maintenance */
    .ligne-card-arretee { border-left-color: #dc3545; } /* Red for arretee */
    
    .ligne-card .card-title a {
        text-decoration: none;
        color: inherit;
    }
    .ligne-card .card-title a:hover {
        text-decoration: underline;
    }
    .stat-item {
        margin-bottom: 0.5rem;
    }
    .stat-item strong {
        color: #495057;
    }
    .equipement-list {
        font-size: 0.9em;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Lignes de Production</h1>
        {% if has_permission('manager') %}
        <a href="{{ url_for('parametres_ligne_production_ajouter') }}" class="btn btn-primary">
            <i class="fas fa-plus-circle me-1"></i> Ajouter Ligne de Production
        </a>
        {% endif %}
    </div>

    <!-- Flashed Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show mb-3" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if lignes %}
    <div class="row">
        {% for ligne in lignes %}
        <div class="col-xl-4 col-lg-6 mb-4">
            <div class="card shadow-sm h-100 ligne-card 
                        {% if ligne.status == 'disponible' %}ligne-card-disponible
                        {% elif ligne.status == 'occupee' %}ligne-card-occupee
                        {% elif ligne.status == 'maintenance' %}ligne-card-maintenance
                        {% elif ligne.status == 'arretee' %}ligne-card-arretee
                        {% endif %}">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title mb-2">
                        <a href="{{ url_for('production_ligne_details', ligne_id=ligne.id) }}">
                            <i class="fas fa-industry me-2"></i>{{ ligne.nom }}
                        </a>
                    </h5>
                    <p class="card-text text-muted small">{{ ligne.description | default('Aucune description.', true) | truncate(100) }}</p>
                    
                    <div class="mt-auto">
                        <hr>
                        <div class="stat-item">
                            <strong>Statut:</strong> 
                            <span class="badge 
                                {% if ligne.status == 'disponible' %}bg-success
                                {% elif ligne.status == 'occupee' %}bg-info
                                {% elif ligne.status == 'maintenance' %}bg-warning text-dark
                                {% elif ligne.status == 'arretee' %}bg-danger
                                {% else %}bg-secondary
                                {% endif %}">
                                {{ ligne.status_display | default(ligne.status | capitalize if ligne.status else 'Inconnu') }}
                            </span>
                        </div>

                        {% if ligne.status == 'occupee' and ligne.production_en_cours %}
                        <div class="stat-item">
                            <strong>En cours:</strong> 
                            <a href="{{ url_for('production_details', production_id=ligne.production_en_cours.id) }}">
                                {{ ligne.production_en_cours.produit_nom }} (Lot: {{ ligne.production_en_cours.numero_lot }})
                            </a>
                        </div>
                        {% endif %}
                        
                        <div class="stat-item"><strong>Capacité:</strong> {{ ligne.capacite | default('N/A', true) }} unités/heure</div>

                        {% if ligne.stats %}
                        <div class="stat-item">
                            <strong>Productions:</strong> {{ ligne.stats.nb_productions | default(0) }} | 
                            <strong>Total Produit:</strong> {{ ligne.stats.total_produit | round(0) | default(0) }} unités
                        </div>
                        {% endif %}

                        {% if ligne.equipements %}
                        <div class="mt-2">
                            <p class="mb-1 equipement-list"><strong>Équipements sur cette ligne:</strong></p>
                            <ul class="list-inline equipement-list mb-0">
                                {% for equipement in ligne.equipements %}
                                <li class="list-inline-item">
                                    <span class="badge bg-light text-dark border">{{ equipement.nom }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                 <div class="card-footer bg-transparent border-top-0 text-end pb-3">
                     <a href="{{ url_for('production_ligne_details', ligne_id=ligne.id) }}" class="btn btn-sm btn-outline-primary">
                        Détails de la Ligne <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info text-center" role="alert">
        Aucune ligne de production n'a été configurée pour le moment.
        {% if has_permission('manager') %}
        <a href="{{ url_for('parametres_ligne_production_ajouter') }}" class="alert-link">Ajouter une nouvelle ligne</a>.
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block custom_js %}
{# Any specific JS for this page could go here #}
{% endblock %}
